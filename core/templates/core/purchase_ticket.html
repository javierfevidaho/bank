{% extends "base_generic.html" %}
{% load static %}

{% block content %}
<div class="frame p-3">
    <h2>Purchase Tickets</h2>
    <p>Your current balance is: ${{ balance }}</p>
    <p>Ticket Price: $1.00</p>
    <a href="{% url 'view_cart' %}" class="btn btn-info">View Cart (<span id="cart-count">{{ request.user.cart.cartitem_set.count }}</span>)</a>
    <div id="tickets-container" class="d-flex flex-wrap">
        <div class="ticket-frame p-3 mb-3">
            <form id="ticket-form" method="post" class="ticket-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="numbers">Select 5 numbers:</label>
                    <div id="numbers" class="d-flex flex-wrap">
                        {% for i in number_range %}
                            <label class="number-label">
                                <input type="checkbox" name="numbers" value="{{ i }}" onchange="handleNumberSelection(this)">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus">Select 1 bonus number:</label>
                    <div id="bonus" class="d-flex flex-wrap">
                        {% for i in bonus_range %}
                            <label class="bonus-label">
                                <input type="radio" name="bonus" value="{{ i }}">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            
                <button type="button" class="btn btn-primary" onclick="autoSelectNumbers(this)">Auto Select</button>
                <button type="button" class="btn btn-success" onclick="addToCart()">Add to Cart</button>
            </form>
        </div>
    </div>
</div>

<script>
    function handleNumberSelection(checkbox) {
        const form = checkbox.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        checkboxes.forEach(cb => {
            if (selectedCount >= 5 && !cb.checked) {
                cb.disabled = true;
            } else {
                cb.disabled = false;
            }
        });
    }

    function autoSelectNumbers(button) {
        const form = button.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        checkboxes.forEach(cb => cb.checked = false);
        const radioButtons = form.querySelectorAll('input[type="radio"][name="bonus"]');
        radioButtons.forEach(rb => rb.checked = false);

        let selectedNumbers = [];
        while (selectedNumbers.length < 5) {
            const randomNum = Math.floor(Math.random() * 35) + 1;
            if (!selectedNumbers.includes(randomNum)) {
                selectedNumbers.push(randomNum);
            }
        }

        selectedNumbers.forEach(num => {
            checkboxes[num - 1].checked = true;
        });

        handleNumberSelection(checkboxes[0]);

        const randomBonus = Math.floor(Math.random() * 14) + 1;
        radioButtons[randomBonus - 1].checked = true;
    }

    function addToCart() {
        const form = document.getElementById('ticket-form');
        const formData = new FormData(form);
        fetch("{% url 'purchase_ticket' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.success);
                updateCartCount();
                form.reset();
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function updateCartCount() {
        fetch("{% url 'view_cart' %}")
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const cartCount = doc.querySelectorAll('.cart-item').length;
            document.getElementById('cart-count').textContent = cartCount;
        });
    }
</script>

<style>
    .number-label, .bonus-label {
        display: inline-block;
        width: 40px;
        height: 40px;
        margin: 5px;
        line-height: 40px;
        text-align: center;
        border: 1px solid #007BFF;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
    }

    .number-label input, .bonus-label input {
        display: none;
    }

    .number-label span, .bonus-label span {
        display: inline-block;
        width: 100%;
        height: 100%;
        line-height: 40px;
        text-align: center;
        border-radius: 50%;
    }

    .number-label input:checked + span, .bonus-label input:checked + span {
        background-color: #007BFF;
        color: white;
    }
</style>
{% endblock %}
