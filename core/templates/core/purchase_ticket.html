{% extends "base_generic.html" %}
{% load static %}
{% load l10n %}
{% load humanize %}
{% block content %}
<div class="frame p-3">
    <h2>Purchase Tickets</h2>
    <p>Your current balance is: ${{ balance|floatformat:2|intcomma }}</p>
    <p>Ticket Price: $1.00</p>
    <a href="{% url 'view_cart' %}" class="btn btn-info">View Cart (<span id="cart-count">{{ request.user.cart.cartitem_set.count }}</span>)</a>
    
    <div class="d-flex justify-content-between">
        <div class="ticket-frame p-3 mb-3">
            <form id="ticket-form" method="post" class="ticket-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="numbers">Select 5 numbers:</label>
                    <div id="numbers" class="number-grid">
                        {% for i in number_range %}
                            <label class="number-label">
                                <input type="checkbox" name="numbers" value="{{ i }}" onchange="handleNumberSelection(this)">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus">Select 1 bonus number:</label>
                    <div id="bonus" class="number-grid">
                        {% for i in bonus_range %}
                            <label class="bonus-label">
                                <input type="radio" name="bonus" value="{{ i }}">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="autoSelectNumbers(this)">Auto Select</button>
                <button type="button" class="btn btn-success" onclick="addToCart()">Add to Cart</button>
            </form>
        </div>

        <div class="quantity-frame p-3 mb-3">
            <form id="quantity-form" method="post" class="quantity-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="quantity">Select quantity:</label>
                    <select id="quantity" name="quantity" class="form-control">
                        <option value="1">1</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                        <option value="80">80</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success" onclick="addBulkToCart()">Add Bulk to Cart</button>
            </form>
        </div>
    </div>
</div>

<div id="bulkModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Selected Numbers</h2>
        <div id="bulk-numbers"></div>
        <button id="confirm-bulk-add" class="btn btn-primary">Confirm</button>
    </div>
</div>

<script>
    window.handleNumberSelection = function(checkbox) {
        const form = checkbox.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        checkboxes.forEach(cb => {
            if (selectedCount >= 5 && !cb.checked) {
                cb.disabled = true;
            } else {
                cb.disabled = false;
            }
        });
    }

    window.autoSelectNumbers = function(button) {
        const form = button.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        checkboxes.forEach(cb => cb.checked = false);
        const radioButtons = form.querySelectorAll('input[type="radio"][name="bonus"]');
        radioButtons.forEach(rb => rb.checked = false);

        let selectedNumbers = [];
        while (selectedNumbers.length < 5) {
            const randomNum = Math.floor(Math.random() * 35) + 1;
            if (!selectedNumbers.includes(randomNum)) {
                selectedNumbers.push(randomNum);
            }
        }

        selectedNumbers.forEach(num => {
            checkboxes[num - 1].checked = true;
        });

        handleNumberSelection(checkboxes[0]);

        const randomBonus = Math.floor(Math.random() * 14) + 1;
        radioButtons[randomBonus - 1].checked = true;
    }

    window.addToCart = function() {
        const form = document.getElementById('ticket-form');
        const formData = new FormData(form);
        fetch("{% url 'purchase_ticket' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.success);
                updateCartCount();
                form.reset();
                window.location.href = "{% url 'payment' %}";
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function updateCartCount() {
        fetch("{% url 'view_cart' %}")
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const cartCount = doc.querySelectorAll('.cart-item').length;
            document.getElementById('cart-count').textContent = cartCount;
        });
    }

    window.addBulkToCart = function() {
        const quantity = parseInt(document.getElementById('quantity').value);
        const bulkNumbers = [];
        for (let i = 0; i < quantity; i++) {
            let selectedNumbers = [];
            while (selectedNumbers.length < 5) {
                const randomNum = Math.floor(Math.random() * 35) + 1;
                if (!selectedNumbers.includes(randomNum)) {
                    selectedNumbers.push(randomNum);
                }
            }
            const randomBonus = Math.floor(Math.random() * 14) + 1;
            bulkNumbers.push({ numbers: selectedNumbers, bonus: randomBonus });
        }

        const bulkModal = document.getElementById('bulkModal');
        const bulkNumbersDiv = document.getElementById('bulk-numbers');
        bulkNumbersDiv.innerHTML = '';
        bulkNumbers.forEach((ticket, index) => {
            const ticketDiv = document.createElement('div');
            ticketDiv.innerHTML = `<strong>Ticket ${index + 1}:</strong> Numbers: ${ticket.numbers.join(', ')}, Bonus: ${ticket.bonus}`;
            bulkNumbersDiv.appendChild(ticketDiv);
        });

        bulkModal.style.display = 'block';

        document.getElementById('confirm-bulk-add').onclick = function() {
            fetch("{% url 'purchase_ticket' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: JSON.stringify({ bulk_tickets: bulkNumbers })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.success);
                    updateCartCount();
                    bulkModal.style.display = 'none';
                } else if (data.error) {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    }

    const modal = document.getElementById('bulkModal');
    const span = document.getElementsByClassName('close')[0];

    span.onclick = function() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}
