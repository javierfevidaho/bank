{% extends "base_generic.html" %}
{% load static %}
{% load l10n %}
{% load humanize %}
{% block content %}
<div class="frame p-3">
    <h2>Purchase Tickets</h2>
    <p>Your current balance is: ${{ balance|floatformat:2|intcomma }}</p>
    <p>Ticket Price: $1.00</p>
    <div class="d-flex justify-content-between">
        <div class="ticket-frame p-3 mb-3">
            <form id="ticket-form" method="post" class="ticket-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="numbers">Select 5 numbers:</label>
                    <div id="numbers" class="number-grid">
                        {% for i in number_range %}
                            <label class="number-label">
                                <input type="checkbox" name="numbers" value="{{ i }}" onchange="handleNumberSelection(this)">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-group">
                    <label for="bonus">Select 1 bonus number:</label>
                    <div id="bonus" class="number-grid">
                        {% for i in bonus_range %}
                            <label class="bonus-label">
                                <input type="radio" name="bonus" value="{{ i }}">
                                <span>{{ i }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="autoSelectNumbers(this)">Auto Select</button>
                <button type="button" class="btn btn-success" onclick="addToCart()">Add to Cart</button>
            </form>
        </div>
        <div class="quantity-frame p-3 mb-3">
            <form id="quantity-form" method="post" class="quantity-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="quantity">Select quantity:</label>
                    <select id="quantity" name="quantity" class="form-control">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                        <option value="80">80</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success" onclick="addBulkToCart()">Add Bulk to Cart</button>
            </form>
        </div>
    </div>
    <a href="{% url 'view_cart' %}" class="btn btn-info mt-3">View Cart (<span id="cart-count">{{ request.user.cart.cartitem_set.count }}</span>)</a>
</div>

<div id="bulkModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Selected Numbers</h2>
        <div id="bulkNumbers"></div>
        <button class="btn btn-primary" onclick="confirmBulk()">Confirm</button>
    </div>
</div>

<script>
    window.handleNumberSelection = function(checkbox) {
        const form = checkbox.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

        checkboxes.forEach(cb => {
            if (selectedCount >= 5 && !cb.checked) {
                cb.disabled = true;
            } else {
                cb.disabled = false;
            }
        });
    }

    window.autoSelectNumbers = function(button) {
        const form = button.closest('form');
        const checkboxes = form.querySelectorAll('input[type="checkbox"][name="numbers"]');
        checkboxes.forEach(cb => cb.checked = false);
        const radioButtons = form.querySelectorAll('input[type="radio"][name="bonus"]');
        radioButtons.forEach(rb => rb.checked = false);

        let selectedNumbers = [];
        while (selectedNumbers.length < 5) {
            const randomNum = Math.floor(Math.random() * 35) + 1;
            if (!selectedNumbers.includes(randomNum)) {
                selectedNumbers.push(randomNum);
            }
        }

        selectedNumbers.forEach(num => {
            checkboxes[num - 1].checked = true;
        });

        handleNumberSelection(checkboxes[0]);

        const randomBonus = Math.floor(Math.random() * 14) + 1;
        radioButtons[randomBonus - 1].checked = true;
    }

    window.addToCart = function() {
        const form = document.getElementById('ticket-form');
        const formData = new FormData(form);
        fetch("{% url 'purchase_ticket' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.success);
                updateCartCount();
                form.reset();
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function updateCartCount() {
        fetch("{% url 'view_cart' %}")
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const cartCount = doc.querySelectorAll('.cart-item').length;
            document.getElementById('cart-count').textContent = cartCount;
        });
    }

    window.addBulkToCart = function() {
        const quantity = document.getElementById('quantity').value;
        const tickets = generateTickets(quantity);
        const bulkNumbersDiv = document.getElementById('bulkNumbers');
        bulkNumbersDiv.innerHTML = '';
        tickets.forEach((ticket, index) => {
            const ticketDiv = document.createElement('div');
            ticketDiv.textContent = `Ticket ${index + 1}: Numbers: ${ticket.numbers.join(', ')}, Bonus: ${ticket.bonus}`;
            bulkNumbersDiv.appendChild(ticketDiv);
        });
        document.getElementById('bulkModal').style.display = 'block';
    }

    function generateTickets(quantity) {
        const tickets = [];
        for (let i = 0; i < quantity; i++) {
            const numbers = [];
            while (numbers.length < 5) {
                const randomNum = Math.floor(Math.random() * 35) + 1;
                if (!numbers.includes(randomNum)) {
                    numbers.push(randomNum);
                }
            }
            const bonus = Math.floor(Math.random() * 14) + 1;
            tickets.push({ numbers, bonus });
        }
        return tickets;
    }

    function closeModal() {
        document.getElementById('bulkModal').style.display = 'none';
    }

    window.confirmBulk = function() {
        const tickets = [];
        const bulkNumbersDiv = document.getElementById('bulkNumbers').children;
        for (let i = 0; i < bulkNumbersDiv.length; i++) {
            const ticketText = bulkNumbersDiv[i].textContent;
            const numbers = ticketText.match(/Numbers: (.*), Bonus/)[1].split(', ').map(Number);
            const bonus = parseInt(ticketText.match(/Bonus: (\d+)/)[1]);
            tickets.push({ numbers, bonus });
        }

        const formData = new FormData();
        formData.append('bulk_tickets', JSON.stringify(tickets));
        fetch("{% url 'purchase_ticket' %}", {
            method: 'POST',
            body: JSON.stringify({ tickets }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.success);
                updateCartCount();
                closeModal();
            } else if (data.error) {
                alert(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>
{% endblock %}
